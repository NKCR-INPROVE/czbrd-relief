/* *****************************************************************************
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package cz.incad.czbrd.common;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.Serializable;
import java.math.BigDecimal;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import org.w3c.dom.Document;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.xml.sax.SAXException;

/**
 *******************************************************************************
 *
 * @author Marek
 */
public class ZiskejStream implements Serializable {

    private static final Logger LOG = Logger.getLogger(ZiskejStream.class.getName());

    /**
     ***************************************************************************
     * soukromý defaultní konstruktor
     */
    public ZiskejStream() {
    }

    /**
     * povolení vlastníci záznamů jsou ABA001, BOA001 a OLA001
     */


    /**
     * vrátí stream z definovaného linku
     * @param link (String) - link pro otevření spojení
     * @return
     * @throws IOException 
     */
    private InputStream openConnection(String link) throws IOException {
        if (!"http".equals(link.substring(0, 4))) link = "http://" + link;
        URL url = new URL(link);
        if (LOG.isLoggable(Level.FINE)) {
            LOG.log(Level.FINE, url.toExternalForm());
        }
        HttpURLConnection huc = (HttpURLConnection) url.openConnection();
        huc.setConnectTimeout(60 * 1000);
        huc.setReadTimeout(60 * 1000);
        huc.connect();
        return huc.getInputStream();        
    }
    
    private InputStream openConnectionFile(String fileName) throws IOException {
        if (!Utils.jePrazdne(fileName)) {
            File soubor = new File(fileName);
            InputStream fileInputStream = new FileInputStream(soubor);
            return fileInputStream;
        } else {
            return null;
        }
    }
    
    public OneRecord getStream(String linkStart, String base, String ccnb, String carKod) {
        OneRecord oneRecord = new OneRecord();
        String linkKonec = "";
        if (Utils.jePrazdne(base)) { base = "nkc"; }
        if (!Utils.jePrazdne(ccnb)) {
            return getStreamFind(linkStart, "?op=find&request=cnb=" + ccnb + "&base=" + base, base);
        } else if (!Utils.jePrazdne(carKod)) {
            return getStreamFind(linkStart, "?op=find&request=barcode=" + carKod + "&base=" + base, base);
        }
        return null;
    }

    private OneRecord getStreamFind(String linkStart, String linkKonec, String base) {
        OneRecord oneRecord = new OneRecord();
        InputStream streamLocal = null;
        DocumentBuilderFactory dbFactoryLocal = null;
        DocumentBuilder dBuilderLocal = null;
        Document docLocal = null;
        String link = linkStart + linkKonec;
        String chyba = "";
        LOG.log(Level.SEVERE, " getStreamFind: 1 - " + link);
        try {
            int pocetOpakovani = 0;
            Boolean opakuj = true;
            while ((opakuj) && (pocetOpakovani<5) ) {
                try {
                    LOG.log(Level.SEVERE, "zkousim nacist data (Find) - pokus c: " + pocetOpakovani);
                    if ("http".equals(linkStart.substring(0, 4))) {
                        streamLocal = this.openConnection(link);
                    } else {
                        streamLocal = this.openConnectionFile(link);                    
                    }
                    dbFactoryLocal = DocumentBuilderFactory.newInstance();
                    dBuilderLocal = dbFactoryLocal.newDocumentBuilder();
                    docLocal = dBuilderLocal.parse(streamLocal);
                    opakuj = false;
                } catch (IOException ex) {
                    LOG.log(Level.SEVERE, " chyba io: " + ex.getMessage());
                } catch (ParserConfigurationException ex) {
                    LOG.log(Level.SEVERE, " chyba parsovani: " + ex.getMessage());
                    opakuj = false;
                } catch (SAXException ex) {
                    LOG.log(Level.SEVERE, " chyba sax: " + ex.getMessage());            
                    opakuj = false;
                }
                pocetOpakovani++;
            }

            if (docLocal!=null) {
                String setNumber = "";
                String numberRecord = "";
                String numberEntries = "";
                NodeList nListIdentifiers = docLocal.getElementsByTagName("find");
                Node nChildBase = nListIdentifiers.item(0);
                NodeList nlChild = nChildBase.getChildNodes();
                for (int i=0; i<nlChild.getLength(); i++) {
                    Node nChild = nlChild.item(i);
                    if ("set_number".equals(nChild.getNodeName())) {
                        setNumber = Utils.vratString(nChild);
                    } else if ("no_records".equals(nChild.getNodeName())) {
                        numberRecord = Utils.vratString(nChild);
                    } else if ("no_entries".equals(nChild.getNodeName())) {
                        numberEntries = Utils.vratString(nChild);
                    } else if ("error".equals(nChild.getNodeName())) {
                        chyba = Utils.vratString(nChild);
                    }
            LOG.log(Level.SEVERE, "  nChild: " + nChild.toString() + " - " + nListIdentifiers.toString());
                }
            LOG.log(Level.SEVERE, "  find: 1 - " + setNumber + " - " + numberRecord);
                if (!Utils.jePrazdne(chyba)) {
                    LOG.log(Level.SEVERE, "Záznam nenalezen:");
                    return null;
                } else
//                if ((!"".equals(link)) & (!Utils.jePrazdne(setNumber)) & (!Utils.jePrazdne(numberRecord))) {
                if ((!Utils.jePrazdne(setNumber)) & (!Utils.jePrazdne(numberRecord))) {
                    //String source = link.substring(link.indexOf("&base="));
                    //if (source.indexOf("&")>0) { source = source.substring(0, source.indexOf("&") - 1); }
                    String linkNew = "";
                    if (numberEntries.equals(numberRecord)) {
                        linkNew = "?op=present&set_no=" + setNumber+ "&set_entry=" + numberEntries + "&base=" + base;
                    } else {
                        linkNew = "?op=present&set_no=" + setNumber+ "&set_entry=" + numberEntries + "," + numberRecord + "&base=" + base;
                    }
                LOG.log(Level.SEVERE, "  find: 2" + linkNew);
                    return getStreamFind2(linkStart, linkNew, base);
                }
            }
        } catch (Exception ex) {
            LOG.log(Level.SEVERE, "Chyba při zpracování streamu: " + ex.getMessage());
        }
        return null;
    }

    public OneRecord getStreamFind2(String linkStart, String linkKonec, String base) {
        OneRecord oneRecord = new OneRecord();
        InputStream streamLocal = null;
        DocumentBuilderFactory dbFactoryLocal = null;
        DocumentBuilder dBuilderLocal = null;
        Document docLocal = null;
        String link = linkStart + linkKonec;
        String chyba = "";
        LOG.log(Level.SEVERE, " getStreamFind2: 1 - " + link);
        try {
            int pocetOpakovani = 0;
            Boolean opakuj = true;
            while ((opakuj) && (pocetOpakovani<5) ) {
                try {
                    LOG.log(Level.SEVERE, "zkousim nacist data (Find2) - pokus c: " + pocetOpakovani);
                    if ("http".equals(linkStart.substring(0, 4))) {
                        streamLocal = this.openConnection(link);
                    } else {
                        streamLocal = this.openConnectionFile(link);                    
                    }
                    dbFactoryLocal = DocumentBuilderFactory.newInstance();
                    dBuilderLocal = dbFactoryLocal.newDocumentBuilder();
                    docLocal = dBuilderLocal.parse(streamLocal);
                    opakuj = false;
                } catch (IOException ex) {
                    LOG.log(Level.SEVERE, " chyba io: " + ex.getMessage());
                } catch (ParserConfigurationException ex) {
                    LOG.log(Level.SEVERE, " chyba parsovani: " + ex.getMessage());
                    opakuj = false;
                } catch (SAXException ex) {
                    LOG.log(Level.SEVERE, " chyba sax: " + ex.getMessage());            
                    opakuj = false;
                }
                pocetOpakovani++;
            }

            if (docLocal!=null) {
                LOG.log(Level.SEVERE, "dokument nacten - parsuji");
                String setNumber = "";
                String numberRecord = "";
                String numberEntries = "";
                String docNumber = "";
                try {
                    NodeList nListIdentifiers = docLocal.getElementsByTagName("doc_number");
                    Node nChildBase = nListIdentifiers.item(0);
                    docNumber = Utils.vratString(nChildBase);
                    LOG.log(Level.SEVERE, " docNumber: " + nChildBase.toString() + " - " + docNumber);
                } catch (Exception e) {
                    docNumber = "";
                }
                try {
                    NodeList nListIdentifiers = docLocal.getElementsByTagName("error");
                    Node nChildBase = nListIdentifiers.item(0);
                    chyba = Utils.vratString(nChildBase);
                } catch (Exception e) {
                    chyba = "";
                }
                if (!Utils.jePrazdne(chyba)) {
                    LOG.log(Level.SEVERE, "Záznam nenalezen:");
                    return null;
                } else
                if (!Utils.jePrazdne(docNumber)) {
                    String linkNew = "";
                    String localBase = "";
                    if ("nkc".equals(base)) {
                        localBase = "nkc01";
                    } else if ("nkc".equals(base)) {
                        localBase = "nkc01";
                    } else if ("nkc".equals(base)) {
                        localBase = "nkc01";
                    }
                    linkNew = linkStart + "?op=ill_get_doc&doc_number=" + docNumber + "&library=nkc01";
                    LOG.log(Level.SEVERE, "  find2: 2" + linkNew);
                    return getStreamDetail(linkNew);
                }
            }
        } catch (Exception ex) {
            LOG.log(Level.SEVERE, "Chyba při zpracování streamu: " + ex.getMessage());
        }
        return null;
    }
    
    public OneRecord getStreamDetail(String link) {
        OneRecord oneRecord = new OneRecord();
        InputStream streamLocal = null;
        DocumentBuilderFactory dbFactoryLocal = null;
        DocumentBuilder dBuilderLocal = null;
        Document docLocal = null;
    LOG.log(Level.SEVERE, "detail 1: " + link);
        try {
            int pocetOpakovani = 0;
            Boolean opakuj = true;
            while ((opakuj) && (pocetOpakovani<5) ) {
                try {
                    LOG.log(Level.SEVERE, "zkousim nacist data (Detail) - pokus c: " + pocetOpakovani);
                    if ("http".equals(link.substring(0, 4))) {
                        streamLocal = this.openConnection(link);
                    } else {
                        streamLocal = this.openConnectionFile(link);                    
                    }
                    dbFactoryLocal = DocumentBuilderFactory.newInstance();
                    dBuilderLocal = dbFactoryLocal.newDocumentBuilder();
                    docLocal = dBuilderLocal.parse(streamLocal);
                    opakuj = false;
                } catch (IOException ex) {
                    LOG.log(Level.SEVERE, " chyba io: " + ex.getMessage());
                } catch (ParserConfigurationException ex) {
                    LOG.log(Level.SEVERE, " chyba parsovani: " + ex.getMessage());
                    opakuj = false;
                } catch (SAXException ex) {
                    LOG.log(Level.SEVERE, " chyba sax: " + ex.getMessage());            
                    opakuj = false;
                }
                pocetOpakovani++;
            }
            
    LOG.log(Level.SEVERE, "detail ");
            if (docLocal!=null) {
                NodeList nListIdentifiers = docLocal.getElementsByTagName("record");
                oneRecord.fill(nListIdentifiers.item(0));
            }
        } catch (Exception ex) {
            LOG.log(Level.SEVERE, "Chyba při zpracování streamu: " + ex.getMessage());
        }
        return oneRecord;
    }
    
}
